# 任务管理功能增强 - 实现文档

## 📋 概述

根据用户需求，我们实现了方案 C（双层管理）：
- **侧边栏**：提供快速任务预览和批量快捷操作
- **任务中心**：提供完整的任务管理功能，包括选择、筛选、批量操作

## ✅ 已实现功能

### 1. 数据库层增强 (`learning/db.py`)

新增了以下批量操作方法：

#### `batch_update_status(job_ids, new_status)`
- 批量更新多个任务的状态
- 参数：
  - `job_ids`: 任务ID列表
  - `new_status`: 新状态（'pending', 'paused', 'running', 'deleted'等）
- 返回：更新的任务数量

#### `batch_delete_jobs(job_ids)`
- 批量删除任务（设置为deleted状态）
- 参数：`job_ids` - 任务ID列表
- 返回：删除的任务数量

#### `delete_completed_jobs()`
- 删除所有已完成的任务
- 返回：删除的任务数量

#### `get_all_jobs(include_deleted=False)`
- 获取所有任务
- 参数：`include_deleted` - 是否包含已删除的任务
- 返回：任务列表

### 2. 侧边栏增强 (`ui/sidebar.py`)

#### 功能特性：
- ✅ 显示最近3个任务的详细信息
- ✅ 显示任务状态图标（🟢运行、🔵等待、🟡暂停、🔴失败）
- ✅ 显示任务进度条（仅运行中的任务）
- ✅ 快速批量操作按钮：
  - "⏸️ 全部暂停" - 暂停所有运行中和等待中的任务
  - "▶️ 全部恢复" - 恢复所有暂停的任务
- ✅ 自动显示/隐藏（仅在有活跃任务时显示）

### 3. 任务中心完全重构 (`ui/pages/self_learning.py`)

#### 核心功能：

##### 任务选择
- ✅ 每个任务前的复选框
- ✅ "☑️ 全选" 按钮 - 选择当前筛选条件下的所有任务
- ✅ "⬜ 全不选" 按钮 - 清除所有选择
- ✅ 实时显示已选中任务数量

##### 状态筛选
- ✅ 多选筛选器，支持筛选：
  - 🟢 运行中
  - 🔵 等待中
  - 🟡 已暂停
  - 🔴 失败
  - ✅ 已完成
- ✅ 默认显示活跃任务（运行、等待、暂停、失败）

##### 批量操作（对选中任务）
- ✅ "⏸️ 批量暂停" - 暂停选中的任务
- ✅ "▶️ 批量恢复" - 恢复选中的任务
- ✅ "🔄 批量重试" - 重试选中的失败任务
- ✅ "🗑️ 批量删除" - 删除选中的任务
- ✅ "❌ 取消选择" - 清除当前选择

##### 全局批量操作
- ✅ "⏸️ 暂停所有活跃任务" - 暂停所有运行中和等待中的任务
- ✅ "▶️ 恢复所有暂停任务" - 恢复所有暂停的任务
- ✅ "🗑️ 清理已完成任务" - 删除所有已完成的任务

##### 任务详情显示
- ✅ 任务标题（来自payload或文件名）
- ✅ 任务类型（🎥 视频学习 / 📚 古籍研读）
- ✅ 任务ID
- ✅ 运行时长（自动计算：X小时X分钟）
- ✅ 创建时间
- ✅ 当前状态
- ✅ 进度条（百分比和阶段名称）
- ✅ 可展开的详细信息面板：
  - 任务信息（类型、状态、目标文件）
  - 时间信息（创建、更新、运行时长）
  - Payload数据（包括可点击的URL链接）

##### 单个任务操作
- ✅ "▶️ 恢复" / "⏸️ 暂停" - 根据状态显示
- ✅ "🔄 重试" - 仅失败任务显示
- ✅ "🗑️ 删除" - 暂停、失败、已完成任务可删除

##### 附加功能
- ✅ "🔄 刷新" 按钮 - 手动刷新任务列表
- ✅ "🔄 自动刷新" 开关 - 每5秒自动刷新
- ✅ 任务统计面板 - 显示各状态任务数量

## 🎨 UI/UX 设计亮点

### 1. 双层管理架构
- **侧边栏**：轻量级快速操作，不离开当前页面
- **任务中心**：完整功能，适合深度管理

### 2. 智能交互
- 全选功能只选择当前筛选条件下的任务
- 批量操作按钮仅在有选中任务时可见
- 单个任务操作按钮根据任务状态动态显示
- 删除操作通过类型为"primary"的按钮提示重要性

### 3. 信息可视化
- 彩色状态图标（🟢🔵🟡🔴✅）
- 进度条实时显示
- 运行时长自动计算
- 阶段信息（下载中、转录中、分析中等）

### 4. 用户友好
- 操作后自动清除选择
- 操作成功后显示toast提示
- 智能标题截断（payload优先于文件名）
- URL链接可点击

## 📊 测试结果

运行 `test_task_management.py` 的测试结果：

```
✅ 批量暂停: 5个任务 - 通过
✅ 批量恢复: 5个任务 - 通过  
✅ 批量删除: 5个任务 - 通过
✅ 任务统计: 正确显示各状态计数 - 通过
✅ 所有测试通过！
```

## 🔧 技术实现细节

### Session State 管理
使用 `st.session_state.selected_jobs` (set) 来跟踪选中的任务ID，确保：
- 快速查找（O(1)）
- 自动去重
- 持久化（在同一会话内）

### 运行时长计算
```python
def calc_elapsed_time(created_at_str):
    created = datetime.strptime(created_at_str, "%Y-%m-%d %H:%M:%S")
    elapsed = datetime.now() - created
    hours = int(elapsed.total_seconds() // 3600)
    minutes = int((elapsed.total_seconds() % 3600) // 60)
    # 格式化显示
```

### 批量操作优化
数据库层使用 SQL IN 语句进行批量更新，而不是循环单独更新：
```python
query = f"UPDATE job_queue SET status = ? WHERE id IN ({placeholders})"
```

### 错误处理
- 侧边栏任务监控使用 try-except 静默失败，避免影响主界面
- 任务中心有明确的错误提示和用户反馈

## 📝 使用指南

### 侧边栏快速操作
1. 查看最近3个任务的状态
2. 点击"⏸️ 全部暂停"快速暂停所有活跃任务
3. 点击"▶️ 全部恢复"快速恢复所有暂停任务

### 任务中心完整管理
1. 导航到 **[自我进化] → [任务中心]**
2. 使用状态筛选器只显示关心的任务
3. 勾选需要操作的任务复选框
4. 使用批量操作按钮进行操作
5. 或直接使用单个任务的操作按钮

### 推荐工作流

#### 清理失败任务
1. 筛选状态：只选择"🔴 失败"
2. 点击"☑️ 全选"
3. 点击"🗑️ 批量删除"

#### 暂时停止所有学习
1. 侧边栏点击"⏸️ 全部暂停"
   或
2. 任务中心点击"⏸️ 暂停所有活跃任务"

#### 重试失败任务
1. 筛选状态：只选择"🔴 失败"
2. 勾选需要重试的任务
3. 点击"🔄 批量重试"

## 🚀 后续可能的增强

- [ ] 任务优先级调整
- [ ] 任务详情编辑
- [ ] 任务日志查看
- [ ] 任务执行历史
- [ ] 导出任务报告
- [ ] 任务搜索功能
- [ ] 批量导入任务

## 📦 相关文件

- `learning/db.py` - 数据库批量操作方法
- `ui/sidebar.py` - 侧边栏任务监控
- `ui/pages/self_learning.py` - 任务中心页面
- `test_task_management.py` - 功能测试脚本
- `TODO.md` - 需求跟踪文档
