# 图网络引擎集成文档 (V33.0)

## 概述

本文档描述图网络引擎（Graph Network Engine）在 Antigravity UI 系统中的集成实现。

**版本**: V33.0  
**日期**: 2025-01-16

---

## 集成功能

### 1. 双引擎切换 (Dual Engine Toggle)

**位置**: 侧边栏（适用于所有使用引擎的模式）

**功能**:
- 用户可以在 "Legacy (线性)" 和 "Graph (图网络)" 之间实时切换
- 切换后立即生效，无需重启

**实现位置**:
- `ui/sidebar.py`: 添加引擎选择 Radio 按钮
- `ui/pages/quantum_lab.py`: 根据选择初始化对应引擎

### 2. 引擎适配器 (Engine Adapter)

**文件**: `core/engine_adapter.py`

**功能**:
- 将图网络引擎的输出转换为与 Legacy 引擎兼容的格式
- 确保现有 UI 代码无需修改即可使用图网络引擎

**关键方法**:
- `calculate_energy()`: 调用图网络引擎并转换结果格式
- `_convert_to_standard_format()`: 结果格式转换

### 3. 拓扑可视化 (Topology Visualization)

**位置**: 量子验证页面 → "🌐 网络拓扑" Tab

**可视化内容**:

1. **拓扑结构图** (`render_topology_graph`)
   - 节点：表示八字粒子（天干/地支）
   - 节点大小：与能量值成正比
   - 节点颜色：按五行元素着色
   - 连线：表示节点间的关系（权重）

2. **能量流动对比** (`render_energy_flow_comparison`)
   - 对比初始能量 H^(0) 和最终能量 H^(final)
   - 显示能量在传播过程中的变化

3. **邻接矩阵热图** (`render_adjacency_heatmap`)
   - 显示完整的邻接矩阵
   - 红色 = 正权重（生/合），蓝色 = 负权重（克/冲）

### 4. 引擎对比视图 (Engine Comparison)

**位置**: 量子验证页面 → "单点分析" Tab

**功能**:
- 当使用 Graph 引擎时，如果有 Legacy 结果，显示对比
- 对比项：
  - 身强身弱判定
  - 财富得分
  - 差异分析

---

## 使用流程

### 步骤 1: 选择引擎

1. 打开量子验证页面
2. 在侧边栏找到 "⚙️ 计算引擎 (Engine)" 部分
3. 选择 "Graph (图网络)" 模式

### 步骤 2: 选择案例

1. 在 "单点分析" Tab 中选择一个测试案例
2. 查看计算结果（与 Legacy 引擎格式一致）

### 步骤 3: 查看拓扑

1. 切换到 "网络拓扑" Tab
2. 查看拓扑结构图、能量流动对比和邻接矩阵

### 步骤 4: 对比验证

1. 切换回 Legacy 引擎
2. 查看 Legacy 结果
3. 切换回 Graph 引擎
4. 在 "单点分析" Tab 底部查看对比结果

---

## 技术细节

### 文件结构

```
core/
  ├── engine_graph.py          # 图网络引擎核心实现
  └── engine_adapter.py        # 引擎适配器

ui/
  ├── sidebar.py               # 侧边栏（引擎切换）
  ├── pages/
  │   └── quantum_lab.py       # 量子验证页面（集成点）
  └── components/
      └── graph_visualizer.py  # 拓扑可视化组件
```

### 依赖库

确保以下 Python 库已安装：

```python
numpy          # 矩阵运算
networkx       # 图结构处理（用于可视化）
plotly         # 交互式图表
streamlit      # UI 框架
```

如果缺少 `networkx`，需要添加到 `requirements.txt`：

```txt
networkx>=2.8
```

---

## 预期效果

### Graph 引擎的优势

1. **动态传导**: 能够模拟能量的动态流动，而不仅仅是静态累加
2. **复杂交互**: 通过矩阵传播，能够捕捉"隔位生"等复杂关系
3. **可视化**: 提供直观的拓扑图，让用户"看见命运的脉络"

### 对比示例

**案例**: 马云（极弱食伤制杀格）

- **Legacy 引擎**: 可能因为身弱而低估财富
- **Graph 引擎**: 能够识别"食伤制杀"的流通转化，正确评估财富层次

---

## 故障排除

### 问题 1: 拓扑图不显示

**原因**: 可能缺少 `networkx` 库

**解决**: 
```bash
pip install networkx
```

### 问题 2: Graph 引擎报错

**检查**:
1. 确保 `core/engine_graph.py` 存在且无语法错误
2. 检查配置参数是否正确加载
3. 查看 Streamlit 控制台的错误信息

### 问题 3: 对比视图不显示

**原因**: 需要先运行 Legacy 引擎，然后切换到 Graph 引擎

**解决**: 按照使用流程，先 Legacy 后 Graph

---

## 下一步改进

1. **性能优化**: 矩阵运算可以进一步优化（使用 GPU）
2. **更多可视化**: 添加能量流动动画
3. **参数调优**: 将图网络引擎的参数也加入调优脚本
4. **批处理支持**: 在全局校准中也支持 Graph 引擎

---

**文档维护**: 如有更新，请及时更新本文档。

