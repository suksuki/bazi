# Antigravity App - Core Engine Upgrade (V4.3 Quantum Kernel) Technical Specification

**Role:** Lead System Architect  
**Date:** 2025-12-10  
**Status:** Ready for Implementation  

---

## Module 1: Data Schema Upgrade (Composite Object Model)

We are moving away from simple string representations. The `EarthlyBranch` will now be a rich object representing a Composite Particle.

### Class Definition: `EarthlyBranch`

```python
from dataclasses import dataclass, field
from typing import List, Dict
from enum import Enum

class SpinDirection(Enum):
    CLOCKWISE = 1  # Yang / Positive
    COUNTER_CLOCKWISE = -1 # Yin / Negative

class ParticleState(Enum):
    NORMAL = "Normal"
    ENTANGLED = "Entangled"   # In a Combine/He relationship
    SUPPRESSED = "Suppressed" # Controlled/Clashed
    ACTIVATED = "Activated"   # Resonating/Rooted

@dataclass
class EnergyCore:
    stem: str           # The Hidden Stem character (e.g., "丙")
    element: str        # 'Fire', 'Earth', etc.
    weight: float       # Ratio (e.g., 0.60)
    spin: SpinDirection # Inherited or intrinsic spin
    
@dataclass
class EarthlyBranch:
    # --- 1. Identity & Shell Properties ---
    char: str           # e.g., "巳"
    element: str        # Main Qi Element (e.g., "Fire")
    polarity: int       # 1 (Yang) or -1 (Yin)
    
    # Shell Visualization Props
    shell_color: str    # Hex code
    shell_opacity: float # 0.0 - 1.0
    spin_direction: SpinDirection

    # --- 2. Internal Core Structure ---
    # The "Nucleus" composition
    cores: List[EnergyCore] = field(default_factory=list)

    # --- 3. Real-time Quantum State ---
    energy_level: float = 50.0 # Dynamic Energy (0-100)
    status: ParticleState = ParticleState.NORMAL
    
    def __post_init__(self):
        # Auto-initialize cores based on standard lookups if empty
        pass

    def get_main_qi(self) -> EnergyCore:
        # Return the core with highest weight
        return max(self.cores, key=lambda x: x.weight)
```

## Module 2: Core Algorithms (Vector Physics)

### 2.1 Algorithm: Rooting Effect (Resonance Calculation)

```python
def calculate_rooting_effect(stem: str, branch_list: List[EarthlyBranch]) -> float:
    """
    Calculates the amplification factor for a Heavenly Stem based on Branch connections.
    Physics: Inverse-Square Law approximation for Distance.
    """
    # Base Multiplier (Vacuum state)
    multiplier = 1.0
    stem_element = get_element(stem)
    
    # Distance Coefficients (0=Same Pillar, 1=Near, 2=Far, 3=Remote)
    # Weights decay over distance
    DISTANCE_FACTORS = {0: 1.0, 1: 1.5, 2: 2.5, 3: 4.0}
    
    ROOT_WEIGHT_CONSTANT = 0.5 # Base added value per root

    for i, branch in enumerate(branch_list):
        # 1. Scan Cores inside this Branch particle
        for core in branch.cores:
            if core.element == stem_element:
                
                # 2. Calculate Distance Factor (assuming 'i' correlates to distance)
                # In practice, need precise pillar index difference
                dist_factor = DISTANCE_FACTORS.get(i, 4.0) 
                
                # 3. Calculate Resonance Strength
                # Formula: More weight in core = stronger resonance
                resonance_strength = (core.weight * ROOT_WEIGHT_CONSTANT * 2.0) / dist_factor
                
                # 4. Integrate into Multiplier
                multiplier += resonance_strength
                
                # Side Effect: Activate Branch State
                branch.status = ParticleState.ACTIVATED
                
    return multiplier
```

### 2.2 Algorithm: Phase Locking (Tri-Harmony Cyclotron)

```python
def check_phase_locking(branch_list: List[EarthlyBranch]) -> Dict:
    """
    Detects San He (Tri-Harmony) interactions and applies structural transformation.
    Example: Si (Snake) + You (Rooster) + Chou (Ox) -> Metal Frame
    """
    events = []
    
    # Metal Frame Definition
    METAL_FRAME = {"巳", "酉", "丑"}
    
    # 1. Detection
    current_chars = {b.char for b in branch_list}
    
    if METAL_FRAME.issubset(current_chars):
        # TRI-HARMONY DETECTED
        
        # 2. Identify Particles Involved
        involved_particles = [b for b in branch_list if b.char in METAL_FRAME]
        
        total_energy_pool = 0.0
        
        # 3. Transform Particles
        for p in involved_particles:
            # A. Phase Lock State
            p.status = ParticleState.ENTANGLED
            
            # B. Energy Fusion (Summation)
            total_energy_pool += p.energy_level
            
            # C. Suppression of Rebel Qi (Non-Metal Cores)
            # E.g., Bing Fire in Si Snake is suppressed by the Metal Gague
            for core in p.cores:
                if core.element != "Metal":
                    core.weight *= 0.1 # Forced reduction to 10%
                    # core.status = Suppressed
        
        # 4. Apply Resonance Coefficient
        RESONANCE_COEFF = 1.5
        amplified_energy = total_energy_pool * RESONANCE_COEFF
        
        # 5. Distribute Back (or create Field Object)
        # In V4.3, we might return a 'Field Object' instead of modifying particles only
        event = {
            "type": "Phase_Lock",
            "element": "Metal",
            "particles": [b.char for b in involved_particles],
            "total_field_energy": amplified_energy,
            "entropy_change": "Low" # Ordered state
        }
        events.append(event)

    return events
```

## Module 3: Output Protocol (Visual-Computation Interface)

### API Response Schema

```json
{
  "quantum_field_analysis": {
    "metadata": {
      "version": "V4.3",
      "timestamp": "2025-12-10T15:00:00Z"
    },
    "energy_spectrum": {
      "metal_kill_force": 128.5,  "//": "Calculated via Flux Engine (Metal Qi)",
      "fire_rebel_force": 42.0,   "//": "Residual Fire Qi in composition",
      "wood_growth_potential": 15.2
    },
    "structural_entropy": "High", "//": "Derived from Conflict/Clash count. High = Volatile.",
    "pattern_type": "Fake_Follow_Kill", "//": "AI Classification of chart structure"
  },
  
  "visual_engine_instruction": {
    "global_settings": {
        "bloom_intensity": 1.2,
        "background_grid_warp": 0.5
    },
    "particles": [
      {
        "id": "year_branch_si",
        "char": "巳",
        "position": [-4.5, 0, -2.0],
        "visual_type": "Red_Plasma_Reactor", 
        "shell_opacity": 0.4,
        "vibration_freq": 85, "//": "Maps to local energy level. High Hz = Shaking mesh.",
        "connection_target": "year_stem_ding", "//": "Draw Beam (Rooting)",
        "status_effect": "Phase_Locked_Metal" "//": "Apply material shader override (Silver fluid)"
      },
      {
        "id": "month_branch_you",
        "char": "酉",
        "position": [-1.5, 0, -2.0],
        "visual_type": "White_Crystal_Core",
        "vibration_freq": 120,
        "status_effect": "Phase_Locked_Metal"
      }
    ],
    "field_effects": [
       {
           "type": "Cyclotron_Loop",
           "nodes": ["year_branch_si", "month_branch_you", "day_branch_chou"],
           "color": "#C0C0C0",
           "flow_speed": 5.0
       }
    ]
  }
}
```
