# V10.0 调优策略升级 - 结构感知调优

**日期**: 2025-01-17  
**版本**: V10.0  
**状态**: ✅ 已实施

---

## 📋 核心分析师战略定调

基于核心分析师的深度分析，V10.0 调优策略从**"调位置"转向"调结构"**，并引入**样本锚定策略**和**贝叶斯正则化**。

---

## 🎯 一、从"调位置"转向"调结构"

### 1.1 核心理念

**能量的爆发点在于"根 (Root)"和"透 (Stem)"，而不在于"柱 (Pillar)"。**

### 1.2 错误调法（线性）

❌ **错误示例**：为了修好比尔·盖茨（时支有根），把 `pillarWeights.hour` 从 0.1 提到 0.3。

**问题**：结果导致所有时柱无根的人都被高估。

### 1.3 正确调法（非线性/结构化）

✅ **正确示例**：
- 保持 `pillarWeights.hour` 相对较低（如 0.15）
- 大幅提升 **`structure.rootingWeight` (通根权重)** 和 **`structure.samePillarBonus` (同柱互通)**

**效果**：
- 对于**比尔·盖茨**（辛亥时，金水相生，亥为壬水之禄）：触发了 `Rooting` + `SamePillar` 的双重非线性加成。能量 E = 0.15 × (1 + Bonus_root + Bonus_same) ≈ 0.45。**结果：变强。**
- 对于**普通人**（时柱无根无生）：只有基础权重。E = 0.15 × 1 = 0.15。**结果：维持原状。**

**总结**：这就是**"有根则重，无根则轻"**的自适应非线性。

---

## 📊 二、样本锚定策略

### 2.1 核心定性

**八字是"天体物理学"，它是普世的。** 八字的本质是**日地关系**（太阳射角、季节气候、地球自转角度）。只要人住在地球上，受太阳系能量影响，八字理论就**一定适用**。

**结论**：我们坚信这是普世理论。**不要专门为外国人搞一套"特殊算法"。**

### 2.2 现实困境：数据噪音

既然理论是普世的，为什么外国案例容易跑偏？因为**"输入端"**太脏了。

**问题**：
1. **真太阳时 (True Solar Time)**：八字必须用真太阳时。中国古代没有时区概念，正午就是午时。但现代外国人（尤其是美国人）的出生时间受**夏令时 (DST)** 和 **宽时区** 的严重干扰。
2. **南半球反转**：南半球的 6 月是冬天（水旺），而北半球是夏天（火旺）。如果系统直接把 6 月当午月（火）算，那物理基础就全反了。

### 2.3 应对策略：以"古籍"为锚，视"洋人"为验证

**我们不能让一群时间可能不准、节气可能反转的现代外国人数据，去篡改《滴天髓》几千年总结下来的物理常数。**

#### 策略A：样本加权（锚定效应）

**权重分配**：
- **Classic Cases (古籍)**：权重 **3.0x**。这是"宪法"，用来校准基础参数（如月令权重）。
- **Modern Chinese (现代名人)**：权重 **1.5x**。
- **Foreigners (外国人)**：权重 **0.8x**。这是"压力测试"。如果算不准，首先怀疑是不是真太阳时校正出了问题，而不是怀疑算法错了。

#### 策略B：数据清洗

1. **真太阳时检查**：对于 `geo_country != 'China'` 的案例，**强制检查**是否经过了严格的经纬度真太阳时校正。如果未校正，宁可丢弃，也不进训练集。
2. **南半球处理**：V10.0 必须具备"月令反转"的逻辑开关（针对南半球案例，月支对冲取气，如午月取子水之气）。

---

## 🔧 三、贝叶斯正则化（Bayesian Prior Penalty）

### 3.1 核心思想

我们不写死 `if Month < Hour then Error`，而是给优化器一个**"物理直觉"**。

### 3.2 实现方式

在 Loss Function 中加入正则化项 (Regularization)：

```
Loss = -Match_Rate + λ × Penalty_Terms
```

**含义**：
- 系统允许你在特定情况下让时柱权重大于月令
- 但是，你必须证明这样做能让预测准确率**显著**提升（抵消掉 λ 的惩罚）
- 如果提升不明显，系统会自动收敛回"月令 > 时柱"的稳态

### 3.3 惩罚项设计

#### 惩罚项1：月令 vs 时柱权重

```
if hour_weight > month_weight:
    penalty += λ × (hour_weight - month_weight) × 10.0
```

**示例**：如果 `hour_weight=1.3, month_weight=1.2`，惩罚 = 5.0 × 0.1 × 10 = 5.0%

#### 惩罚项2：通根权重上限

```
if rooting_weight > 3.0:
    penalty += λ × (rooting_weight - 3.0) × 2.0
```

#### 惩罚项3：同柱加成上限

```
if same_pillar_bonus > 2.5:
    penalty += λ × (same_pillar_bonus - 2.5) × 2.0
```

---

## 🎯 四、分层锁定法 (Layered Locking)

不要把几十个参数放在一个锅里乱炖。

### Step 1：物理层 (Physics)

用经典案例锁定月令、季节的基础权重。调好后**Freeze（冻结）**。

### Step 2：结构层 (Structure)

调通根、透干、库的开闭。解决盖茨这类结构特殊的问题。

### Step 3：微观层 (Micro)

调 GAT 的 Attention Dropout，处理极其细微的杂气干扰。

---

## 📊 五、实施总结

### 5.1 已实施的改进

1. ✅ **样本加权系统**
   - 经典案例权重 3.0x
   - 现代中国案例权重 1.5x
   - 外国人案例权重 0.8x

2. ✅ **结构参数调优**
   - 优先优化 `structure.rootingWeight` (通根权重)
   - 优化 `structure.samePillarBonus` (同柱加成)
   - 不再简单调整位置权重

3. ✅ **贝叶斯正则化**
   - 实现惩罚项计算
   - 抑制不合理参数组合
   - 使用最终得分（加权匹配率 - 惩罚项）作为优化目标

### 5.2 调优参数优先级

**优先级1（结构层）**：
- `structure.rootingWeight`: 1.0 ~ 2.5
- `structure.samePillarBonus`: 1.0 ~ 2.0

**优先级2（判定层）**：
- `strength.energy_threshold_center`: 2.0 ~ 4.0
- `strength.follower_threshold`: 0.1 ~ 0.2

**优先级3（微观层）**：
- `gat.attention_dropout`: 0.1 ~ 0.5

---

## 🚀 六、使用指南

### 6.1 结构参数敏感度分析

```bash
# 通根权重敏感度分析
python3 scripts/strength_parameter_tuning.py \
    --mode sensitivity \
    --param structure.rootingWeight \
    --min 1.0 \
    --max 2.5 \
    --steps 15

# 同柱加成敏感度分析
python3 scripts/strength_parameter_tuning.py \
    --mode sensitivity \
    --param structure.samePillarBonus \
    --min 1.0 \
    --max 2.0 \
    --steps 12
```

### 6.2 结构参数联合优化

```bash
# 结构参数网格搜索（自动包含贝叶斯正则化）
python3 scripts/strength_parameter_tuning.py --mode optimize
```

**默认优化参数**：
- `structure.rootingWeight`: 1.0 ~ 2.5 (8步)
- `structure.samePillarBonus`: 1.0 ~ 2.0 (6步)
- `strength.follower_threshold`: 0.1 ~ 0.2 (5步)

---

## 📋 七、预期效果

### 7.1 对比效果

| 案例 | 旧方法（调位置） | 新方法（调结构） |
|------|-----------------|-----------------|
| **比尔·盖茨** | ❌ 误判（Weak） | ✅ 正确（Strong） |
| **普通人（无根）** | ❌ 被高估 | ✅ 维持原状 |
| **整体准确率** | 50.0% | 预期 60%+ |

### 7.2 关键改进

1. **自适应非线性**：有根则重，无根则轻
2. **物理一致性**：以古籍为锚，不被脏数据误导
3. **参数合理性**：贝叶斯正则化确保参数在合理范围内

---

**维护者**: Bazi Predict Team  
**最后更新**: 2025-01-17

