# Antigravity V8.8 Work Order
# 《架构重构与稳定版》工作指令
# =======================================
# Created: 2025-12-14
# Status: READY TO START
# Codename: "Foundation Reinforcement"

---

## 0. 版本定位 (Version Positioning)

```
V8.1 (当前)          V8.8 (下一步)         V9.0 (未来)
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 逻辑补丁版   │ ─→  │ 架构重构版   │ ─→  │ 新维度版     │
│             │     │             │     │             │
│ • 功能正确   │     │ • 代码干净   │     │ • 天时地利   │
│ • 代码混乱   │     │ • 模块解耦   │     │ • 完整体系   │
│ • 60% Pass  │     │ • 60% Pass  │     │ • 80%+ Pass │
└─────────────┘     └─────────────┘     └─────────────┘
     ▲                    ▲                    ▲
   现在                打地基              盖大楼
```

---

## 1. 核心任务 (Core Tasks)

### Task 1: 建立 UI 契约 (Server-Driven UI Protocol)

**目标文件**: `core/schemas/response_protocol.py`

```python
# V8.8 核心协议
from pydantic import BaseModel
from typing import Optional, List, Dict

class UIInstruction(BaseModel):
    """前端渲染指令 - 后端决定如何展示"""
    display_color: str          # "#E74C3C" (危险红), "#27AE60" (安全绿)
    display_icon: str           # "fire-alert", "water-flow", "earth-stable"
    badge_text: str             # "严重失衡", "身强得令", "调候急需"
    chart_effect: Optional[str] # "withered_tree", "scorched_earth", "frozen_water"
    tooltip: Optional[str]      # 悬浮提示文字

class StrengthResult(BaseModel):
    """身强身弱判定结果"""
    verdict: str                # "Strong", "Weak", "Moderate", "Follower"
    raw_score: float            # 未调整的基础分
    adjusted_score: float       # 调候后的最终分
    confidence: float           # 0.0 - 1.0 置信度
    
class PhaseChangeInfo(BaseModel):
    """相变信息 (V8.0 焦土/冻水)"""
    is_active: bool
    type: Optional[str]         # "scorched_earth", "frozen_water", "humid_rescue"
    damping_factor: float       # 0.15 焦土, 0.30 冻水, 0.80 润局
    description: str

class AnalysisOutput(BaseModel):
    """V8.8 标准输出协议"""
    # 核心判定
    strength: StrengthResult
    favorable_elements: List[str]
    unfavorable_elements: List[str]
    
    # 详细分解
    base_physics: Dict[str, float]  # 基础能量分布
    phase_change: PhaseChangeInfo   # 相变状态
    
    # UI 指令 (核心改进!)
    ui_guide: UIInstruction
    
    # 调试信息
    debug: Optional[Dict] = None
```

### Task 2: 引擎模块化 (Engine Modularization)

**目标结构**:

```
core/
├── engine.py                  # QuantumEngine (调度总线, ~200行)
├── schemas/                   # [V8.8 NEW] 协议层
│   ├── __init__.py
│   └── response_protocol.py   # Pydantic 模型定义
└── processors/                # [V8.8 NEW] 专家模块层
    ├── __init__.py
    ├── base_physics.py        # 纯五行生克 (从 _calculate_energy_v7 提取)
    ├── seasonal.py            # 月令/得令/调候 (从 _evaluate_wang_shuai 提取)
    ├── phase_change.py        # V8.0 焦土/冻水逻辑 (独立隔离)
    ├── strength_judge.py      # 阈值判定器 (固定阈值 + 得令覆盖)
    └── pattern.py             # 格局识别 (从格/建禄格等)
```

### Task 3: 回归测试保障 (Regression Safety Net)

**要求**: V8.8 结束时，25 个案例的通过率必须 **≥ V8.1 (60%)**

```python
# test_v88_regression.py
def test_regression_no_degradation():
    """确保重构不破坏现有功能"""
    v81_results = load_v81_baseline()  # 从文件加载 V8.1 的结果
    v88_results = run_v88_engine()
    
    for case_id in v81_results:
        if v81_results[case_id]['pass']:
            assert v88_results[case_id]['pass'], f"Regression in {case_id}"
```

---

## 2. 详细文件清单 (File Manifest)

### 新建文件 (Create)

| 路径 | 描述 | 预计行数 |
|------|------|----------|
| `core/schemas/__init__.py` | 包初始化 | 5 |
| `core/schemas/response_protocol.py` | UI 契约协议 | 80 |
| `core/processors/__init__.py` | 包初始化 + 导出 | 20 |
| `core/processors/base_physics.py` | 五行能量计算 | 150 |
| `core/processors/seasonal.py` | 月令/调候逻辑 | 100 |
| `core/processors/phase_change.py` | 焦土/冻水/润局 | 80 |
| `core/processors/strength_judge.py` | 阈值判定 | 60 |
| `core/processors/pattern.py` | 格局识别 (初始) | 50 |
| `tests/test_v88_regression.py` | 回归测试 | 100 |

### 修改文件 (Modify)

| 路径 | 改动 | 预计变化 |
|------|------|----------|
| `core/quantum_engine.py` | 删除内联逻辑，改为调用 processors | -800 行 |
| `core/engines/flow_engine.py` | 移动到 processors/phase_change.py | 重构 |

---

## 3. 执行顺序 (Execution Order)

### Step 1: 建立骨架
```bash
mkdir -p core/schemas core/processors
touch core/schemas/__init__.py
touch core/processors/__init__.py
```

### Step 2: 创建协议 (30 min)
- 编写 `response_protocol.py`
- 定义所有 Pydantic 模型

### Step 3: 提取 BasePhysics (1 hr)
- 从 `_calculate_energy_v7` 提取纯能量计算
- 移动到 `processors/base_physics.py`

### Step 4: 提取 Seasonal (1 hr)
- 从 `_evaluate_wang_shuai` 提取得令/印绶逻辑
- 移动到 `processors/seasonal.py`

### Step 5: 隔离 PhaseChange (30 min)
- 从 `flow_engine.py` 提取焦土/冻水逻辑
- 移动到 `processors/phase_change.py`

### Step 6: 重构 QuantumEngine (1 hr)
- 删除所有内联计算
- 改为调用 processors
- 组装 AnalysisOutput

### Step 7: 回归测试 (30 min)
- 运行 25 案例批测
- 确保 ≥ 60% 通过

---

## 4. 验收标准 (Acceptance Criteria)

| 检查项 | 标准 |
|--------|------|
| 代码行数 | `quantum_engine.py` ≤ 300 行 |
| 模块数量 | 至少 4 个 processor 文件 |
| 回归通过率 | ≥ 60% (不低于 V8.1) |
| Pydantic 契约 | `AnalysisOutput` 已定义并使用 |
| 类型提示 | 所有新文件 100% 类型注解 |

---

## 5. 风险与应对 (Risks)

| 风险 | 应对 |
|------|------|
| 重构过程中引入 bug | 每完成一个 Step 就运行回归测试 |
| 循环引用 | processors 之间禁止互相 import |
| 遗漏逻辑 | 保留 `_legacy_evaluate()` 作为对照 |

---

## 6. 下次工作指令 (Next Session Command)

```
Master: 启动 V8.8 重构
- Step 1: 创建目录骨架
- Step 2: 编写 response_protocol.py
- Step 3-5: 提取并隔离 processors
- Step 6: 重构 QuantumEngine
- Step 7: 回归验证
```

---

**V8.8 WORK ORDER END**
