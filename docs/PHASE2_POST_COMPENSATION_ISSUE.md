# Phase 2 后置补偿问题分析

## 问题总结

F1 三合水案例失败：
- 量子纠缠后能量：190.48
- 传播后能量：256.84
- 能量比率：1.348（预期：2.0）
- 误差：32.6%

## 已修复的问题

### 1. 硬编码的bonus值（984-991行）✅
- **问题**：硬编码了 `1.55` 作为三合局的bonus
- **修复**：改为使用配置中的 `threeHarmony.bonus`（已改为2.0）

### 2. 配置值调整 ✅
- **问题**：`threeHarmony.bonus = 1.8`，不等于预期的2.0
- **修复**：已改为 `2.0`

## 仍存在的问题

### 后置补偿逻辑未生效

**代码位置**：958-1126行（后置补偿逻辑）

**预期行为**：
- 在合局中的节点（申、子、辰）应该通过1118-1126行的后置补偿达到2.0倍率
- 不在合局中的节点（壬）应该通过645-715行的扩展保护达到2.0倍率

**实际行为**：
- 所有节点都没有达到预期的2.0倍率
- 在合局中的节点：申(16.99 < 28.24)、子(51.26 < 86.78)、辰(25.39 < 37.84)
- 不在合局中的节点：壬(78.93 < 105.24)

## 可能的原因

### 1. 后置补偿逻辑的条件判断问题
- `is_in_combo` 可能没有正确设置
- `combo_bonus` 的值可能没有正确传递

### 2. 扩展保护逻辑的匹配问题
- 扩展保护在 `H_new` 上应用，但可能被后续逻辑覆盖
- 匹配逻辑可能不够精确（依赖字符串匹配）

### 3. 执行顺序问题
- 后置补偿在928-1126行，在循环外部执行
- 但可能在错误的时机执行（在H被修改之前）

## 需要进一步检查

1. **调试后置补偿逻辑**：添加日志，确认是否被执行
2. **检查is_in_combo**：确认节点是否被正确标记为在合局中
3. **检查combo_bonus**：确认值是否正确传递（应该是2.0）
4. **检查扩展保护**：确认是否在正确的时机应用

## 下一步行动

1. 添加调试日志，追踪后置补偿的执行
2. 检查条件判断逻辑
3. 验证combo_bonus的值传递

