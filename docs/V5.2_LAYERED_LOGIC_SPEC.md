# Antigravity Core Engine - V5.2 Layered Logic Protocol
# "The Three-Layer Pyramid" Architecture

## Overview
This document defines the strict hierarchical processing order for the Quantum Bazi Engine to resolve conflicts between Physics Rules (Vector Math) and Empirical Rules (Ancient Texts).

## Layer 0: The Kernel Axioms (Physics Basis)
**Priority: CRITICAL / IMMUTABLE**
*Code Location: `core/bazi_calculator` & `Particle.__init__`*

1.  **Solar Time Axiom**: All inputs must be True Solar Time based on Longitude.
2.  **Composite Particle Axiom**: Branches are NOT strings; they are Shell-Core composite objects with specific ZangGan ratios.
3.  **Vector Axiom**: Interactions are vector sums, not lookup tables.

## Layer 1: Dynamic Field Laws (Interaction Logic)
**Priority: HIGH (Determines Base State)**
*Code Location: `core/flux._run_phase_locking` & `_run_rooting`*

1.  **Phase Locking (San He)**: 
    - Rule: If (Si+You+Chou) exists, Force Collapse to METAL.
    - Override: This overrides the individual elemental natures of the participating branches (except for residual Rebel Qi).
2.  **Vector Rooting**:
    - Energy transmission decays by distance ($1/D^{1.5}$).
    - Stem Energy = Stem.Base + Sum(Branch.Core * Overlap * Decay).

*Output: `E_Physics` (Raw Quantum Energy Scores)*

## Layer 2: Heuristic Adjustments (Empirical Patches)
**Priority: MEDIUM (Adjusts Interpretation, does not change Physics)**
*Code Location: `core/flux._layer2_heuristics`*

1.  **Threshold Judgments (Hard Rules)**:
    - **Logic**: IF `E_Physics` meets a specific threshold condition, override the STATUS.
    - **Example (Metal > Fire*5)**: Even if Fire exists (Physics), if Metal is 5x stronger, Fire is marked as "Suffocated". The energy value remains, but its functional utility drops to zero.
    
2.  **Learned Weights (Soft Rules)**:
    - **Logic**: Apply multipliers based on AI-mined patterns.
    - **Example**: `E_Final = E_Physics * (1 + Learned_Weight)`.
    - **Input**: Derived from `data/learned_rules.json` (Vreal Scores).

## Conflict Resolution Algorithm
**Example: Fire vs Metal Bureau**

1.  **L1 Calc**: 
    - Metal Field = 150.0
    - Fire Root = 55.0
2.  **L2 Check**:
    - Rule: "Metal extinguishes Fire" if Ratio > 5:1.
    - Current Ratio: 150/55 = 2.7.
    - Result: **False**. Fire survives.
    - Rule: "Fire forges Metal" (Effective Work).
    - Result: **True**.
3.  **Final Output**:
    - Metal is Strong (Resource), Fire is Useful (Officer/Killer).格局成立。

---
**Implementation Note:**
Code structures must explicitly separate these steps. `FluxEngine` must call `_layer1` then `_layer2` sequentially.
