# QGA V25.0 Phase 5.2 性能优化建议

## 当前性能指标

### 小规模测试结果（10样本）
- **成功率**: 100% ✅
- **平均处理时间**: 85.14秒/样本
- **吞吐量**: 0.02样本/秒
- **预计1000样本耗时**: 约23.6小时

### 性能瓶颈分析

1. **LLM调用延迟**: 每个样本需要调用LLM生成persona，这是主要瓶颈
2. **并发数不足**: 当前默认4个并发线程，可以增加到8-16个
3. **特征向量提取**: 相对较快，不是主要瓶颈

## 优化方案

### 1. 增加并发线程数

**当前**: `max_workers=4`
**建议**: `max_workers=8` 或 `max_workers=16`

**修改位置**: `tests/batch_pressure_test_v25.py` 第30行

```python
def __init__(self, sample_count: int = 1000, max_workers: int = 8):  # 从4改为8
```

**预期效果**: 
- 8线程: 约11.8小时（减少50%）
- 16线程: 约5.9小时（减少75%）

**注意事项**: 
- 需要确保Ollama服务能处理并发请求
- 如果Ollama服务不稳定，可以降低并发数

### 2. 批量处理优化

可以考虑将样本分批处理，每批完成后保存中间结果，避免全部失败：

```python
# 每100个样本保存一次中间结果
if completed % 100 == 0:
    # 保存中间结果
    self._save_intermediate_results(results)
```

### 3. LLM调用优化

- **使用更快的模型**: 如果qwen2.5:3b太慢，可以考虑使用更小的模型
- **减少Prompt长度**: 优化Prompt模板，减少Token消耗
- **缓存机制**: 对于相同格局的样本，可以缓存LLM响应

### 4. 跳过非关键验证

对于大规模测试，可以：
- 跳过详细的语义自愈验证（只检查是否有persona输出）
- 简化权重归一化验证（只检查是否在合理范围内）

## 推荐配置

### 快速测试（验证逻辑）
- 样本数: 10-50
- 并发数: 2-4
- 预计耗时: 10-30分钟

### 中等规模测试（验证稳定性）
- 样本数: 100-200
- 并发数: 4-8
- 预计耗时: 2-4小时

### 完整压力测试（工业级验证）
- 样本数: 1000
- 并发数: 8-16
- 预计耗时: 6-12小时

## 运行建议

1. **先运行小规模测试**（已完成 ✅）
2. **运行中等规模测试**（100样本）验证并发稳定性
3. **如果稳定，再运行完整1000样本测试**

### 运行命令

```bash
# 小规模测试（10样本，已验证）
python3 tests/batch_pressure_test_small.py

# 中等规模测试（100样本，建议先运行）
python3 -c "
from tests.batch_pressure_test_v25 import BatchPressureTest
tester = BatchPressureTest(sample_count=100, max_workers=8)
tester.run_batch_test()
"

# 完整测试（1000样本）
python3 tests/batch_pressure_test_v25.py
```

## 监控建议

在运行大规模测试时，建议：
1. 监控Ollama服务状态
2. 监控系统资源（CPU、内存）
3. 定期检查日志文件
4. 如果出现大量错误，及时停止并分析

## 性能目标

- **目标吞吐量**: > 0.1样本/秒（10倍提升）
- **目标处理时间**: < 10秒/样本
- **目标总耗时**: < 3小时（1000样本）

通过增加并发数和优化LLM调用，应该可以达到这些目标。

