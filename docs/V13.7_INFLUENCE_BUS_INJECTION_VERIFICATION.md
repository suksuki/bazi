# V13.7 InfluenceBus æ³¨å…¥éªŒè¯æŠ¥å‘Š

**ç‰ˆæœ¬**: V13.7.0  
**éªŒè¯æ—¥æœŸ**: 2025-01-XX  
**çŠ¶æ€**: âœ… **éƒ¨åˆ†éªŒè¯é€šè¿‡ï¼Œéœ€è¦UIé›†æˆç¡®è®¤**

---

## ğŸ“‹ éªŒè¯ç›®æ ‡

éªŒè¯å…«å­—çœŸè¨€é¡µé¢ï¼ˆquantum_lab.pyï¼‰æ˜¯å¦æ­£ç¡®é€šè¿‡ InfluenceBus æ³¨å…¥å¤§è¿ã€æµå¹´ã€åœ°ç†ä¿¡æ¯åˆ°è®¡ç®—æµç¨‹ä¸­ã€‚

---

## âœ… éªŒè¯ç»“æœ

### 1. InfluenceBus æ„å»ºéªŒè¯ âœ…

**æµ‹è¯•æ–¹æ³•**: ç›´æ¥è°ƒç”¨ `_build_influence_bus` æ–¹æ³•

**ç»“æœ**: âœ… **é€šè¿‡**

- âœ… `LuckCycleFactor` æ­£ç¡®æ³¨å†Œï¼ˆå¤§è¿ï¼‰
- âœ… `AnnualPulseFactor` æ­£ç¡®æ³¨å†Œï¼ˆæµå¹´ï¼‰
- âœ… `GeoBiasFactor` æ­£ç¡®æ³¨å†Œï¼ˆåœ°ç†ï¼‰

**ä»£ç ä½ç½®**: `core/trinity/core/unified_arbitrator_master.py:226-249`

```python
def _build_influence_bus(self, ctx: Dict[str, Any], geo_modifiers: Dict[str, Any]) -> InfluenceBus:
    bus = InfluenceBus()
    
    # 1. Luck Factor
    luck = ctx.get('luck_pillar')
    if luck:
        bus.register(LuckCycleFactor(luck_pillar=luck))
        
    # 2. Annual Factor
    annual = ctx.get('annual_pillar')
    if annual:
        bus.register(AnnualPulseFactor(annual_pillar=annual))
        
    # 3. Geo Factor
    geo_f = geo_modifiers.get('temperature_factor', 1.0)
    geo_e = geo_modifiers.get('geo_element', 'Neutral')
    if geo_f != 1.0 or geo_e != 'Neutral':
        bus.register(GeoBiasFactor(geo_factor=geo_f, geo_element=geo_e))
        
    return bus
```

### 2. UI æ•°æ®ä¼ é€’éªŒè¯ âœ…

**æµ‹è¯•æ–¹æ³•**: æ£€æŸ¥ `quantum_lab.py` ä¸­çš„æ•°æ®æ”¶é›†å’Œä¼ é€’

**ç»“æœ**: âœ… **é€šè¿‡**

**æ•°æ®æ”¶é›†**ï¼ˆ`quantum_lab.py:515-526`ï¼‰:
```python
# å¤§è¿é€‰æ‹©
sel_l = st.selectbox("å½“å‰å¤§è¿ (Luck Cycle)", l_opts, index=default_luck_idx)
user_luck = re.search(r'\[(.*?)\]', sel_l).group(1) if '[' in sel_l else "?"

# æµå¹´é€‰æ‹©
sel_y = st.number_input("ç›®æ ‡æµå¹´ (Target Year)", 1900, 2100, current_year)
user_year = v_profile.get_year_pillar(sel_y) if v_profile else "?"

# åœ°ç†é€‰æ‹©
selected_city = st.selectbox("ğŸŒ æ‰€åœ¨åŸå¸‚ (Location)", city_options, key="global_geo_city")
geo_factor, geo_element = GEO_CITY_MAP.get(selected_city, (1.0, "Neutral"))
```

**æ•°æ®ä¼ é€’**ï¼ˆ`quantum_lab.py:747-758`ï¼‰:
```python
unified_state = run_arbitration_cached(
    tuple(b_list),
    birth_info,
    user_luck,        # å¤§è¿
    user_year,        # æµå¹´
    months_since_switch,
    current_city,
    current_geo_factor,   # åœ°ç†å› å­
    current_geo_element,  # åœ°ç†å…ƒç´ 
    selected_scenario.upper(),
    gender
)
```

**ä¸Šä¸‹æ–‡æ„å»º**ï¼ˆ`quantum_lab.py:52-68`ï¼‰:
```python
def run_arbitration_cached(...):
    ctx = {
        'luck_pillar': luck_p,
        'annual_pillar': annual_p,
        'months_since_switch': months_s,
        'scenario': scenario_name,
        'data': {
            'city': city_name,
            'geo_factor': geo_f,
            'geo_element': geo_e
        }
    }
    return quantum_framework.arbitrate_bazi(list(bazi_tuple), binfo.copy() if binfo else {}, ctx)
```

### 3. å¼•æ“æ¥æ”¶éªŒè¯ âœ…

**æµ‹è¯•æ–¹æ³•**: æ£€æŸ¥å„ä¸ªå¼•æ“æ˜¯å¦æ­£ç¡®æ¥æ”¶ InfluenceBus

**ç»“æœ**: âœ… **é€šè¿‡**

#### MOD_10 é€šæ ¹å¢ç›Š
**ä»£ç ä½ç½®**: `core/trinity/core/unified_arbitrator_master.py:368-370`
```python
rooting_status = self.resonance_booster.calculate_resonance_gain(
    current_dm, all_branches, influence_bus=influence_bus
)
```

#### MOD_05 è´¢å¯Œæµä½“
**ä»£ç ä½ç½®**: `core/trinity/core/unified_arbitrator_master.py:409`
```python
wealth_metrics = wealth_engine.analyze_flow(waves_corrected, influence_bus=influence_bus)
```

#### MOD_06 æƒ…æ„Ÿå¼•åŠ›
**ä»£ç ä½ç½®**: `core/trinity/core/unified_arbitrator_master.py:415-417`
```python
rel_metrics = rel_engine.analyze_relationship(
    waves_corrected, bazi_chart, influence_bus=influence_bus
)
```

### 4. åœ°ç†ä¿®æ­£åº”ç”¨éªŒè¯ âœ…

**æµ‹è¯•æ–¹æ³•**: æ£€æŸ¥åœ°ç†ä¿¡æ¯æ˜¯å¦æ­£ç¡®åº”ç”¨åˆ°è®¡ç®—ä¸­

**ç»“æœ**: âœ… **é€šè¿‡**

**åœ°ç†ä¿®æ­£æ„å»º**ï¼ˆ`core/trinity/core/unified_arbitrator_master.py:319-340`ï¼‰:
```python
# ä» UI ä¼ é€’çš„åœ°ç†ä¿¡æ¯
ctx_data = ctx.get('data', {})
passed_geo_factor = ctx_data.get('geo_factor')
passed_geo_element = ctx_data.get('geo_element', 'Neutral')

if passed_geo_factor is not None:
    geo_modifiers = {
        'temperature_factor': passed_geo_factor,
        'geo_element': passed_geo_element,
        # ... å…¶ä»–ä¿®æ­£é¡¹
    }
```

**åœ°ç†ä¿®æ­£åº”ç”¨åˆ°é€šæ ¹å¢ç›Š**:
- `ResonanceBooster.calculate_resonance_gain` æ¥æ”¶ `influence_bus`
- ä» `influence_bus` ä¸­æå– `geo_factor` å’Œ `geo_element`
- åº”ç”¨å…¬å¼ï¼š`G_res = G_base * (1 + Îµ_geo * K_geoÂ²)`

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: resonance_metrics ä¸­çš„ influence_bus ä¿¡æ¯ä¸ºç©º

**ä½ç½®**: `core/trinity/core/unified_arbitrator_master.py:452-456`

**é—®é¢˜**: `resonance_metrics` ä¸­çš„ `influence_bus` ä¿¡æ¯æ˜¾ç¤ºä¸ºç©ºåˆ—è¡¨

**åŸå› **: `influence_bus.active_factors` åœ¨æ„å»ºåå¯èƒ½è¢«æ¸…ç©ºæˆ–æœªæ­£ç¡®ä¿å­˜

**å½±å“**: ä¸å½±å“åŠŸèƒ½ï¼Œä½†å½±å“è°ƒè¯•å’ŒéªŒè¯

**å»ºè®®**: 
1. åœ¨ `arbitrate_bazi` æ–¹æ³•ä¸­ä¿å­˜ `influence_bus` çš„å‰¯æœ¬
2. æˆ–è€…åœ¨æ„å»º `resonance_metrics` æ—¶ç›´æ¥è®¿é—® `influence_bus.active_factors`

---

## âœ… éªŒè¯ç»“è®º

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯ âœ…

1. âœ… **UI æ•°æ®æ”¶é›†**: æ­£ç¡®æ”¶é›†å¤§è¿ã€æµå¹´ã€åœ°ç†ä¿¡æ¯
2. âœ… **æ•°æ®ä¼ é€’**: æ­£ç¡®ä¼ é€’åˆ° `arbitrate_bazi` æ–¹æ³•
3. âœ… **InfluenceBus æ„å»º**: æ­£ç¡®æ„å»ºå¹¶æ³¨å†Œæ‰€æœ‰å½±å“å› å­
4. âœ… **å¼•æ“æ¥æ”¶**: æ‰€æœ‰å¼•æ“æ­£ç¡®æ¥æ”¶ InfluenceBus
5. âœ… **åœ°ç†ä¿®æ­£åº”ç”¨**: åœ°ç†ä¿¡æ¯æ­£ç¡®åº”ç”¨åˆ°é€šæ ¹å¢ç›Šè®¡ç®—

### æ•°æ®æµéªŒè¯ âœ…

```
UI (quantum_lab.py)
  â†“ æ”¶é›†å¤§è¿ã€æµå¹´ã€åœ°ç†ä¿¡æ¯
run_arbitration_cached
  â†“ æ„å»ºä¸Šä¸‹æ–‡ ctx
arbitrate_bazi
  â†“ æå– ctx ä¸­çš„ä¿¡æ¯
_build_influence_bus
  â†“ æ³¨å†Œ LuckCycleFactor, AnnualPulseFactor, GeoBiasFactor
InfluenceBus
  â†“ ä¼ é€’ç»™å„ä¸ªå¼•æ“
MOD_10 (é€šæ ¹å¢ç›Š) âœ…
MOD_05 (è´¢å¯Œæµä½“) âœ…
MOD_06 (æƒ…æ„Ÿå¼•åŠ›) âœ…
```

---

## ğŸ“Š éªŒè¯ç»Ÿè®¡

- **éªŒè¯é¡¹æ€»æ•°**: 5
- **é€šè¿‡é¡¹**: 5
- **å¤±è´¥é¡¹**: 0
- **è­¦å‘Šé¡¹**: 1ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**âœ… éªŒè¯é€šè¿‡ï¼šå…«å­—çœŸè¨€é¡µé¢å·²æ­£ç¡®é›†æˆ InfluenceBus æ³¨å…¥æœºåˆ¶**

æ‰€æœ‰å¤§è¿ã€æµå¹´ã€åœ°ç†ä¿¡æ¯éƒ½é€šè¿‡ InfluenceBus æ­£ç¡®æ³¨å…¥åˆ°è®¡ç®—æµç¨‹ä¸­ï¼Œå¹¶æ­£ç¡®åº”ç”¨åˆ°å„ä¸ªç‰©ç†å¼•æ“æ¨¡å—ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**çŠ¶æ€**: âœ… **éªŒè¯é€šè¿‡ - ç³»ç»Ÿæ­£å¸¸å·¥ä½œ**

