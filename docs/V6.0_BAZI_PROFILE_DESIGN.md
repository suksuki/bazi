# ğŸ—ï¸ V6.0 æ¶æ„å‡çº§è®¡åˆ’ï¼šBaziProfile å¯¹è±¡å±‚
## The Oracle Pattern - ä»å­—å…¸ä¼ é€’åˆ°å¯¹è±¡æŸ¥è¯¢

---

## ğŸ“‹ èƒŒæ™¯

### å½“å‰ç—›ç‚¹ (V5.4)

1. **æ•°æ®é å­—å…¸ä¼ é€’**ï¼š`birth_chart`, `case_data` ç­‰éƒ½æ˜¯æ¾æ•£çš„ `dict`
2. **æ‰‹åŠ¨æ³¨å…¥é—®é¢˜**ï¼šæ¯æ¬¡éœ€è¦åŠ¨æ€å¤§è¿ï¼Œéƒ½è¦æ‰‹åŠ¨ `.copy()` å†æ³¨å…¥
3. **é€»è¾‘åˆ†æ•£**ï¼šå¤§è¿æŸ¥è¯¢é€»è¾‘æ•£è½åœ¨å¤šå¤„ï¼Œéš¾ä»¥ç»´æŠ¤
4. **æ‰©å±•å›°éš¾**ï¼šå¦‚æœè¦åŠ "æµæœˆ"ã€"å°è¿"æŸ¥è¯¢ï¼Œæ”¹åŠ¨é‡å·¨å¤§

### V5.4 çš„ä¸´æ—¶æ–¹æ¡ˆ

```python
# æ‰“è¡¥ä¸æ¨¡å¼ (Patch Mode)
birth_chart_with_luck = birth_chart.copy()
birth_chart_with_luck['current_luck_pillar'] = active_luck
engine.calculate_year_score(..., birth_chart=birth_chart_with_luck)
```

**é—®é¢˜**ï¼šèƒ½å·¥ä½œï¼Œä½†ä¸ä¼˜é›…ï¼Œå®¹æ˜“é—æ¼ã€‚

---

## ğŸ¯ V6.0 æ ¸å¿ƒç›®æ ‡

**å¼•å…¥ `BaziProfile` å¯¹è±¡å±‚ï¼Œå®ç° Single Source of Truthã€‚**

---

## ğŸ›ï¸ è®¾è®¡æ–¹æ¡ˆ

### 1. BaziProfile ç±» (The Oracle)

**æ–‡ä»¶ä½ç½®**ï¼š`core/bazi_profile.py`

```python
from lunar_python import Lunar
from typing import Dict, Optional
from dataclasses import dataclass
from functools import cached_property

@dataclass
class BaziProfile:
    """
    å…«å­—å‘½ç›˜çš„æ™ºèƒ½å¯¹è±¡ã€‚
    å°è£… lunar_python çš„æ‰€æœ‰å¤æ‚æ€§ã€‚
    ä½ ç»™å®ƒå‡ºç”Ÿæ—¶é—´ï¼Œå®ƒç»™ä½ æä¾›ä¸€åˆ‡æŸ¥è¯¢æ¥å£ã€‚
    """
    birth_year: int
    birth_month: int
    birth_day: int
    birth_hour: int
    gender: int  # 1=ç”·, 0=å¥³
    
    def __post_init__(self):
        from lunar_python import Solar
        solar = Solar.fromYmdHms(
            self.birth_year, self.birth_month, self.birth_day, 
            self.birth_hour, 0, 0
        )
        self._lunar = solar.getLunar()
        self._eight_char = self._lunar.getEightChar()
        self._luck_cache: Dict[int, str] = {}
    
    # === åŸºç¡€å±æ€§ ===
    
    @cached_property
    def pillars(self) -> dict:
        return {
            'year': self._eight_char.getYear(),
            'month': self._eight_char.getMonth(),
            'day': self._eight_char.getDay(),
            'hour': self._eight_char.getTime()
        }
    
    @cached_property
    def day_master(self) -> str:
        return self._eight_char.getDayGan()
    
    @cached_property
    def branches(self) -> list:
        """è¿”å›å››æŸ±åœ°æ”¯åˆ—è¡¨"""
        return [
            self._eight_char.getYearZhi(),
            self._eight_char.getMonthZhi(),
            self._eight_char.getDayZhi(),
            self._eight_char.getTimeZhi()
        ]
    
    # === å¤§è¿æŸ¥è¯¢ (æ ¸å¿ƒæœºåˆ¶) ===
    
    def get_luck_pillar_at(self, year: int) -> str:
        """
        ç»™ä¸€ä¸ªå¹´ä»½ï¼Œè¿”å›é‚£å¹´çš„å¤§è¿å¹²æ”¯ã€‚
        ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½ã€‚
        """
        if year in self._luck_cache:
            return self._luck_cache[year]
        
        # è®¡ç®—å¹¶ç¼“å­˜
        yun = self._eight_char.getYun(self.gender)
        dayun_list = yun.getDaYun()
        
        for dayun in sorted(dayun_list, key=lambda x: x.getStartYear()):
            start = dayun.getStartYear()
            end = dayun.getEndYear()
            if start <= year < end:
                result = dayun.getGanZhi()
                self._luck_cache[year] = result
                return result
        
        # æ‰¾æœ€è¿‘çš„
        nearest = min(dayun_list, key=lambda d: abs(d.getStartYear() - year))
        result = nearest.getGanZhi()
        self._luck_cache[year] = result
        return result
    
    def get_luck_timeline(self, num_steps: int = 8) -> Dict[int, str]:
        """è·å–å¤§è¿æ—¶é—´è¡¨"""
        yun = self._eight_char.getYun(self.gender)
        dayun_list = yun.getDaYun()
        
        timeline = {}
        for dayun in dayun_list[:num_steps]:
            timeline[dayun.getStartYear()] = dayun.getGanZhi()
        return timeline
    
    # === æ‰©å±•æŸ¥è¯¢ (æœªæ¥) ===
    
    def get_year_pillar_at(self, year: int) -> str:
        """è·å–æŒ‡å®šå¹´çš„æµå¹´å¹²æ”¯"""
        # TODO: V6.1
        pass
    
    def get_month_pillar_at(self, year: int, month: int) -> str:
        """è·å–æŒ‡å®šæœˆçš„æµæœˆå¹²æ”¯"""
        # TODO: V6.2
        pass
```

### 2. QuantumEngine é€‚é…

**Before (V5.4)**:
```python
def calculate_year_context(
    self,
    year_pillar: str,
    favorable_elements: list,
    unfavorable_elements: list,
    birth_chart: dict,
    year: int = None,
    active_luck: str = None
) -> DestinyContext:
    # æ‰‹åŠ¨æ³¨å…¥é€»è¾‘...
```

**After (V6.0)**:
```python
def calculate_year_context(
    self,
    profile: BaziProfile,
    year: int
) -> DestinyContext:
    """
    æç®€æ¥å£ï¼šåªéœ€è¦ Profile å’Œå¹´ä»½ï¼Œå…¶ä»–å…¨éƒ¨è‡ªåŠ¨è·å–ã€‚
    """
    # 1. ä» Profile è·å–æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯
    current_luck = profile.get_luck_pillar_at(year)
    year_pillar = self._get_year_pillar(year)
    
    # 2. ä» Profile æ¨æ–­å–œå¿Œ
    favorable = self._analyze_favorable(profile)
    unfavorable = self._analyze_unfavorable(profile)
    
    # 3. ç®—åˆ†
    score = self._calculate_score(profile, year_pillar, current_luck)
    
    # 4. è¿”å› DestinyContext
    return DestinyContext(
        year=year,
        pillar=year_pillar,
        luck_pillar=current_luck,
        score=score,
        ...
    )
```

### 3. Dashboard è°ƒç”¨è¿›åŒ–

**Before (V5.4)**:
```python
for y in years:
    # ç®—å¹²æ”¯
    l_gz = f"{l_gan}{l_zhi}"
    
    # ç®—å¤§è¿ (å¤æ‚)
    birth_info = case_data.get('birth_info')
    active_luck = engine.get_dynamic_luck_pillar(...)
    
    # æ„å»ºå­—å…¸ (ç¹ç)
    birth_chart_v4 = {...}
    birth_chart_v4['current_luck_pillar'] = active_luck
    
    # è°ƒç”¨
    ctx = engine.calculate_year_context(
        year_pillar=l_gz,
        favorable_elements=favorable,
        unfavorable_elements=unfavorable,
        birth_chart=birth_chart_v4,
        year=y,
        active_luck=active_luck
    )
```

**After (V6.0)**:
```python
# 1. åˆå§‹åŒ–ä¸€æ¬¡ (é¡µé¢åŠ è½½æ—¶)
profile = BaziProfile(
    birth_year=d.year,
    birth_month=d.month,
    birth_day=d.day,
    birth_hour=t,
    gender=1 if "ç”·" in gender else 0
)

# 2. å¾ªç¯å˜å¾—æç®€
for year in years:
    ctx = engine.calculate_year_context(profile, year)
    # Done!
```

---

## ğŸŒŸ æ”¶ç›Šåˆ†æ

| å¯¹æ¯”é¡¹ | V5.4 (Dict Mode) | V6.0 (Profile Mode) |
|-------|------------------|---------------------|
| **ä»£ç è¡Œæ•°** | ~50è¡Œ/å¹´å¾ªç¯ | ~5è¡Œ/å¹´å¾ªç¯ |
| **å‡ºé”™é£é™©** | é«˜ (æ¼æ³¨å…¥) | ä½ (è‡ªåŠ¨è·å–) |
| **æ€§èƒ½** | æ¯æ¬¡é‡ç®— | ç¼“å­˜ä¼˜åŒ– |
| **æ‰©å±•æ€§** | æ”¹å¤šå¤„ | åŠ æ–¹æ³•å³å¯ |
| **å¯è¯»æ€§** | ä¸­ç­‰ | æé«˜ |

---

## ğŸ›£ï¸ å®æ–½è·¯çº¿

### Phase 1: åŸºç¡€æ¶æ„ (2å°æ—¶)
- [ ] åˆ›å»º `core/bazi_profile.py`
- [ ] å®ç°æ ¸å¿ƒå±æ€§ (pillars, day_master, branches)
- [ ] å®ç° `get_luck_pillar_at()`

### Phase 2: Engine é€‚é… (3å°æ—¶)
- [ ] åˆ›å»º `calculate_year_context_v6()` æ–°æ¥å£
- [ ] ä¿ç•™æ—§æ¥å£å…¼å®¹
- [ ] æ·»åŠ è¿ç§»æŒ‡å—

### Phase 3: UI è¿ç§» (2å°æ—¶)
- [ ] Dashboard ä½¿ç”¨æ–°æ¥å£
- [ ] QuantumLab ä½¿ç”¨æ–°æ¥å£
- [ ] Zeitgeist ä½¿ç”¨æ–°æ¥å£

### Phase 4: æ¸…ç† (1å°æ—¶)
- [ ] ç§»é™¤æ—§æ¥å£
- [ ] æ›´æ–°æ–‡æ¡£
- [ ] å‘å¸ƒ V6.0

**é¢„è®¡æ€»æ—¶é—´**: 8å°æ—¶

---

## ğŸ“ è®°å½•

- **æå‡ºè€…**: ç”¨æˆ· (2025-12-13)
- **åˆ†æè€…**: Antigravity AI
- **çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œå¾… V6.0 å®æ–½
- **ä¼˜å…ˆçº§**: é«˜ (æ¶æ„å€ºåŠ¡)

---

## ğŸ¯ ç»“è®º

**V6.0 çš„æ ¸å¿ƒä½¿å‘½**ï¼š
> ä»"å¤„ç†æ•°æ®å­—å…¸"è¿›åŒ–åˆ°"æŸ¥è¯¢å¯¹è±¡çŠ¶æ€"ã€‚

**BaziProfile** æ˜¯è¿™æ¬¡è¿›åŒ–çš„å…³é”®ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªé‡æ„ï¼Œè€Œæ˜¯è®© Antigravity å…·å¤‡çœŸæ­£çš„**é¢†åŸŸå»ºæ¨¡èƒ½åŠ›**ã€‚

---

**The Oracle Awaits.** ğŸ›ï¸âœ¨
