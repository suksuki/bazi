# V7.0 Architecture: Quantum Trinity & Auto-Tuning (聚变与裂变)

## 1. 核心架构：三位一体 (The Trinity Model)
确立 **"One Source of Truth"** 原则。

*   **量子验证页面 (The Brain/Controller)**: **[唯一写入端]**。
    *   这是整个系统的控制台。
    *   所有的算法参数（权重、系数、阈值）只能在这里修改。
    *   包含“命运参数调控中心”（左侧边栏）和“校准实验室”（批量测试）。

*   **智能排盘 (The Body/Structure)**: **[读取端]**。
    *   **只读**。实时监听参数变化。
    *   UI 上的身强/身弱分值、格局判断不再写死，而是根据接收到的 Config 实时重绘。

*   **命运影院 (The Spirit/Visuals)**: **[读取端]**。
    *   **只读**。实时监听参数变化。
    *   画面的色调、剧情走向、混沌程度，直接响应参数的微调。

**技术实现**: 使用全局 State (Streamlit Session State / React Context equivalent) 广播 `FullAlgoParams` 对象。

---

## 2. 数据结构：全量参数模型 (The Grand Unified Schema)
废除所有硬编码 (Hard-coded) 数值，建立统一的配置接口 `FullAlgoParams`。这将是算法引擎的 **DNA**。

```python
# structure definition in core/config_schema.py

FullAlgoParams = {
  # --- A. 基础物理层 (Base Physics) ---
  "baseEnergy": {
    "rootingWeight": 1.0,       # 通根系数
    "exposedStemBoost": 1.5,    # 透干加成
    "hiddenStemRatios": {       # 藏干比例
      "main": 0.6,              # 本气
      "middle": 0.3,            # 中气
      "remnant": 0.1            # 余气
    },
    "seasonWeights": {          # 旺相休囚死权重
      "wang": 1.2, "xiang": 1.0, "xiu": 0.8, "qiu": 0.6, "si": 0.4
    }
  },

  # --- B. 化学反应层 (Interactions) ---
  "interactions": {
    "stemCombination": {
      "successThreshold": 0.5,  # 合化阈值
      "transformBonus": 5.0     # 合化增益 (Score)
    },
    "conflictDamage": {         # 刑冲破坏力
      "clashFactor": 0.3,       # 冲掉多少能量
      "harmFactor": 0.15        # 害掉多少能量
    },
    "harmony": {
        "sanHeBonus": 15.0,     # 三合加成 (Score)
        "liuHeBonus": 5.0,      # 六合加成 (Score)
        "clashPenalty": -5.0    # 六冲惩罚 (Score)
    }
  },

  # --- C. 逻辑判定层 (Logic) ---
  "patterns": {
    "strengthThreshold": {
      "weak": 35,              # 身弱分界线 (e.g., 2.0 in current scale)
      "strong": 45             # 身强分界线 (e.g., 3.5 in current scale)
    },
    "specialPattern": {
      "followerThreshold": -6.0 # 从格阈值
    }
  },
  
  # --- D. 玄学修正层 (Mystic) ---
  "mystic": {
    "nayinWeight": 0.0,         # 纳音修正系数
    "shenshaImpact": 0.0        # 神煞权重
  }
}
```

---

## 3. UI 模块 A：命运参数调控中心 (左侧边栏)
在量子验证页面左侧，构建 **可配置仪表盘**。

*   **布局**: 使用折叠面板 (Accordion) 分类展示上述 Physics, Interactions, Logic 参数。
*   **组件**: 精密滑块 (Precision Sliders) 与 数值输入框。
*   **交互模式**:
    1.  **手动模式**: 用户拖拽滑块 -> 触发 Global State 更新 -> 排盘/影院实时热重载。
    2.  **Antigravity 托管模式**: UI 锁定或显示“自动运行中”，滑块根据后台指令自动跳动。

---

## 4. UI 模块 B：量子校准实验室 (批量调优)
在量子验证页面底部或独立 Tab，构建 **模型训练/验证** 环境。

*   **功能**:
    1.  **导入基准数据 (Ground Truth)**: 允许导入 N 个已验证的真实八字案例（包含真实的身强/喜用神/大运吉凶结果）。
    2.  **运行基准测试 (Run Benchmark)**: 使用当前的 SideBar 参数，跑测所有案例，计算准确率（Accuracy Score）。
    3.  **保存基石 (Freeze Foundation)**: 找到最佳参数组合后，将其序列化保存为 `golden-rules.json`，作为系统默认算法。

---

## 5. 算法引擎重构 (Refactoring)
修改核心算法函数，从“参数写死”变为“参数注入”。

**Old Way**:
```python
def get_energy(wuxing):
    return wuxing * 1.2
```

**New Way**:
```python
def get_energy(wuxing, config):
    return wuxing * config['baseEnergy']['seasonWeights']['wang']
```

---

**Status**: Planned
**Target Version**: V7.0
**Designation**: TRINITY_ARCH
