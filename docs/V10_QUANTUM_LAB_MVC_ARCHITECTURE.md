# V10.0 é‡å­éªŒè¯é¡µé¢ MVC æ¶æ„æ–‡æ¡£

**æ—¥æœŸ**: 2025-01-17  
**ç‰ˆæœ¬**: V10.0  
**çŠ¶æ€**: âœ… å·²å®æ–½

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜é‡å­éªŒè¯é¡µé¢ï¼ˆ`quantum_lab.py`ï¼‰çš„MVCæ¶æ„é‡æ„ï¼ŒåŒ…æ‹¬Controllerå±‚çš„è®¾è®¡ã€Viewå±‚çš„èŒè´£åˆ’åˆ†ï¼Œä»¥åŠåŠŸèƒ½å®šä½è¯´æ˜ã€‚

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    View Layer                            â”‚
â”‚              (ui/pages/quantum_lab.py)                  â”‚
â”‚  - UIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’                                      â”‚
â”‚  - å‚æ•°è¾“å…¥ç•Œé¢                                          â”‚
â”‚  - ç»“æœå¯è§†åŒ–                                            â”‚
â”‚  - åªè°ƒç”¨Controllerï¼Œä¸ç›´æ¥è°ƒç”¨Engine                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Controller Layer                        â”‚
â”‚        (controllers/quantum_lab_controller.py)           â”‚
â”‚  - å°è£…æ‰€æœ‰ç®—æ³•é€»è¾‘                                      â”‚
â”‚  - åè°ƒEngineå’ŒModelçš„è°ƒç”¨                               â”‚
â”‚  - å¤„ç†MCPä¸Šä¸‹æ–‡æ³¨å…¥                                     â”‚
â”‚  - æä¾›ç»Ÿä¸€çš„æ•°æ®æ¥å£ç»™Viewå±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Engine/Model Layer                     â”‚
â”‚  (core/engine_graph.py, core/bazi_profile.py, etc.)     â”‚
â”‚  - æ ¸å¿ƒè®¡ç®—å¼•æ“                                          â”‚
â”‚  - æ•°æ®æ¨¡å‹å’ŒæŒä¹…åŒ–                                      â”‚
â”‚  - ç®—æ³•å®ç°                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ åŠŸèƒ½å®šä½

### é‡å­éªŒè¯é¡µé¢ï¼ˆç¬¬ä¸€å±‚éªŒè¯ï¼‰

**é¡µé¢**: `ui/pages/quantum_lab.py`

**æ ¸å¿ƒèŒè´£**:
- âœ… **æ—ºè¡°åˆ¤å®š**ï¼šæ ¹æ®å…«å­—ã€å¤§è¿ã€æµå¹´ã€åœ°åŸŸç­‰ä¿¡æ¯åˆ¤å®šèº«å¼ºèº«å¼±
- âœ… **å‚æ•°è°ƒä¼˜**ï¼šè°ƒæ•´æ—ºè¡°åˆ¤å®šç›¸å…³çš„åŸºç¡€å‚æ•°
- âœ… **å¯è§†åŒ–**ï¼šå±•ç¤ºæ—ºè¡°æ¦‚ç‡æ³¢å‡½æ•°ã€èƒ½é‡åˆ†å¸ƒç­‰

**ä¸åŒ…å«çš„åŠŸèƒ½**:
- âŒ **è´¢å¯Œé¢„æµ‹**ï¼šè´¢å¯Œç›¸å…³å‚æ•°å’Œç»“æœæ˜¾ç¤ºï¼ˆå±äºç¬¬äºŒå±‚éªŒè¯ï¼‰
- âŒ **æƒ…æ„Ÿé¢„æµ‹**ï¼šæƒ…æ„Ÿç›¸å…³å‚æ•°å’Œç»“æœæ˜¾ç¤ºï¼ˆå±äºç¬¬äºŒå±‚éªŒè¯ï¼‰
- âŒ **äº‹ä¸šé¢„æµ‹**ï¼šäº‹ä¸šç›¸å…³å‚æ•°å’Œç»“æœæ˜¾ç¤ºï¼ˆå±äºç¬¬äºŒå±‚éªŒè¯ï¼‰

**ç¬¬äºŒå±‚éªŒè¯é¡µé¢**:
- `ui/pages/wealth_verification.py` - è´¢å¯ŒéªŒè¯ï¼ˆåŒ…å«è´¢å¯Œã€æƒ…æ„Ÿã€äº‹ä¸šç­‰å®è§‚æŒ‡æ ‡ï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### Controllerå±‚

**æ–‡ä»¶**: `controllers/quantum_lab_controller.py`

**ç±»**: `QuantumLabController`

**ä¸»è¦æ–¹æ³•**:

1. **Profileåˆ›å»º**:
   - `create_profile_from_case()` - ä»æ¡ˆä¾‹åˆ›å»ºVirtualBaziProfile

2. **MCPä¸Šä¸‹æ–‡å¤„ç†**:
   - `inject_mcp_context()` - æ³¨å…¥MCPä¸Šä¸‹æ–‡ï¼ˆGEOã€ERAã€å¤§è¿ã€æµå¹´ï¼‰
   - `get_luck_pillar()` - è·å–å¤§è¿ï¼ˆä¼˜å…ˆçº§ï¼šMCPä¸Šä¸‹æ–‡ > timeline > VirtualBaziProfileè‡ªåŠ¨åæ¨ï¼‰

3. **æ—ºè¡°è®¡ç®—**:
   - `calculate_strength_score()` - è®¡ç®—æ—ºè¡°åˆ†æ•°å’Œæ ‡ç­¾
   - `evaluate_wang_shuai()` - è¯„ä¼°æ—ºè¡°ï¼ˆè¿”å›æ ‡ç­¾å’Œåˆ†æ•°ï¼‰

4. **èƒ½é‡è®¡ç®—**:
   - `calculate_energy()` - è®¡ç®—èƒ½é‡ï¼ˆç”¨äºå¯è§†åŒ–ï¼‰
   - `calculate_chart()` - è®¡ç®—å…«å­—æ’ç›˜
   - `calculate_year_context()` - è®¡ç®—å¹´ä»½ä¸Šä¸‹æ–‡

5. **é…ç½®ç®¡ç†**:
   - `update_config()` - æ›´æ–°ç®—æ³•é…ç½®å‚æ•°

### Viewå±‚

**æ–‡ä»¶**: `ui/pages/quantum_lab.py`

**èŒè´£**:
- ç”¨æˆ·ç•Œé¢å±•ç¤º
- å‚æ•°è¾“å…¥ï¼ˆä¾§è¾¹æ ï¼‰
- ç»“æœå¯è§†åŒ–ï¼ˆä¸»åŒºåŸŸï¼‰
- è°ƒç”¨Controllerçš„æ–¹æ³•è·å–æ•°æ®

**å…³é”®æ”¹åŠ¨**:
- âœ… ç§»é™¤äº†æ‰€æœ‰ç›´æ¥è°ƒç”¨Engineçš„ä»£ç 
- âœ… æ‰€æœ‰ç®—æ³•è°ƒç”¨éƒ½é€šè¿‡`QuantumLabController`è¿›è¡Œ
- âœ… ç§»é™¤äº†è´¢å¯Œ/æƒ…æ„Ÿ/äº‹ä¸šç­‰å®è§‚æŒ‡æ ‡çš„æ˜¾ç¤º

---

## ğŸ”„ æ•°æ®æµ

### å…¸å‹å·¥ä½œæµç¨‹

1. **ç”¨æˆ·é€‰æ‹©æ¡ˆä¾‹**:
   ```python
   selected_case = load_cases()[0]
   ```

2. **æ³¨å…¥MCPä¸Šä¸‹æ–‡**:
   ```python
   quantum_controller = QuantumLabController()
   case_with_context = quantum_controller.inject_mcp_context(
       selected_case, 
       selected_year=2024
   )
   ```

3. **åˆ›å»ºProfile**:
   ```python
   luck_pillar = quantum_controller.get_luck_pillar(
       case_with_context, 
       target_year=2024
   )
   profile = quantum_controller.create_profile_from_case(
       case_with_context, 
       luck_pillar
   )
   ```

4. **è®¡ç®—æ—ºè¡°**:
   ```python
   ws_label, ws_score = quantum_controller.evaluate_wang_shuai(
       profile.day_master,
       bazi_list
   )
   ```

5. **æ˜¾ç¤ºç»“æœ**:
   ```python
   st.write(f"æ—ºè¡°åˆ¤å®š: {ws_label}")
   st.write(f"èº«å¼ºåˆ†æ•°: {ws_score}")
   ```

---

## ğŸ”§ Controllerè®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£

`QuantumLabController`åªè´Ÿè´£é‡å­éªŒè¯ï¼ˆæ—ºè¡°åˆ¤å®šï¼‰ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ¶‰åŠè´¢å¯Œé¢„æµ‹ç­‰å…¶ä»–åŠŸèƒ½ã€‚

### 2. Lazy Initialization

```python
@property
def engine(self) -> GraphNetworkEngine:
    if self._engine is None:
        self._engine = GraphNetworkEngine()
        self._engine.load_config(self._config)
    return self._engine
```

### 3. çŠ¶æ€ç®¡ç†

Controllerç»´æŠ¤ç®—æ³•é…ç½®çŠ¶æ€ï¼ŒViewå±‚å¯ä»¥é€šè¿‡`update_config()`æ–¹æ³•æ›´æ–°é…ç½®ã€‚

### 4. MCPä¸Šä¸‹æ–‡å¤„ç†

Controllerè´Ÿè´£å¤„ç†MCPä¸Šä¸‹æ–‡æ³¨å…¥ï¼ŒåŒ…æ‹¬ï¼š
- GEOä¸Šä¸‹æ–‡ï¼ˆåœ°ç†ä½ç½®ï¼‰
- ERAä¸Šä¸‹æ–‡ï¼ˆå…ƒè¿ä¿¡æ¯ï¼‰
- å¤§è¿æ¨å¯¼
- æµå¹´è®¡ç®—

---

## ğŸ“Š Viewå±‚è®¾è®¡åŸåˆ™

### 1. çº¯å±•ç¤ºé€»è¾‘

Viewå±‚åªè´Ÿè´£ï¼š
- å‚æ•°è¾“å…¥ç•Œé¢ï¼ˆä¾§è¾¹æ æ»‘å—ã€é€‰æ‹©å™¨ç­‰ï¼‰
- ç»“æœå¯è§†åŒ–ï¼ˆå›¾è¡¨ã€è¡¨æ ¼ç­‰ï¼‰
- ç”¨æˆ·äº¤äº’ï¼ˆæŒ‰é’®ç‚¹å‡»ã€æ¡ˆä¾‹é€‰æ‹©ç­‰ï¼‰

### 2. ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

Viewå±‚ä¸åº”è¯¥åŒ…å«ï¼š
- âŒ å¤æ‚çš„ç®—æ³•åˆ¤æ–­
- âŒ æ•°æ®è½¬æ¢é€»è¾‘
- âŒ ä¸šåŠ¡è§„åˆ™éªŒè¯

### 3. Controllerè°ƒç”¨

æ‰€æœ‰æ•°æ®è·å–éƒ½é€šè¿‡Controllerï¼š

```python
# âœ… æ­£ç¡®
ws_label, ws_score = quantum_controller.evaluate_wang_shuai(...)

# âŒ é”™è¯¯
engine = GraphNetworkEngine()
ws_label = engine.calculate_strength_score(...)
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `tests/test_quantum_lab_controller.py`

**æµ‹è¯•è¦†ç›–**:
- Controlleråˆå§‹åŒ–
- Profileåˆ›å»º
- MCPä¸Šä¸‹æ–‡æ³¨å…¥
- æ—ºè¡°è®¡ç®—
- é…ç½®æ›´æ–°

### é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `tests/test_quantum_lab_mcp_integration.py`

**æµ‹è¯•è¦†ç›–**:
- MCPä¸Šä¸‹æ–‡æ³¨å…¥æµç¨‹
- å®Œæ•´å·¥ä½œæµç¨‹é›†æˆ

### å›å½’æµ‹è¯•

**æ–‡ä»¶**: `tests/test_strength_regression.py`

**æµ‹è¯•è¦†ç›–**:
- æ—ºè¡°åˆ¤å®šå‡†ç¡®æ€§
- å‚æ•°è°ƒä¼˜åçš„å›å½’éªŒè¯

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ·»åŠ æ–°åŠŸèƒ½

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„åŠŸèƒ½åˆ°é‡å­éªŒè¯é¡µé¢ï¼š

1. **åœ¨Controllerä¸­æ·»åŠ æ–¹æ³•**:
   ```python
   def new_feature_method(self, ...):
       # ä¸šåŠ¡é€»è¾‘
       result = self.engine.calculate_something(...)
       return result
   ```

2. **åœ¨Viewå±‚è°ƒç”¨**:
   ```python
   result = quantum_controller.new_feature_method(...)
   st.write(f"ç»“æœ: {result}")
   ```

### 2. å‚æ•°è°ƒä¼˜

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„å‚æ•°è°ƒä¼˜åŠŸèƒ½ï¼š

1. **åœ¨ä¾§è¾¹æ æ·»åŠ å‚æ•°è¾“å…¥**:
   ```python
   new_param = st.slider("æ–°å‚æ•°", 0.0, 1.0, 0.5)
   ```

2. **é€šè¿‡Controlleræ›´æ–°é…ç½®**:
   ```python
   quantum_controller.update_config({
       'new_section': {
           'new_param': new_param
       }
   })
   ```

### 3. é¿å…ç›´æ¥è°ƒç”¨Engine

**âŒ é”™è¯¯ç¤ºä¾‹**:
```python
# åœ¨Viewå±‚ç›´æ¥è°ƒç”¨Engine
from core.engine_graph import GraphNetworkEngine
engine = GraphNetworkEngine()
result = engine.calculate_strength_score(...)
```

**âœ… æ­£ç¡®ç¤ºä¾‹**:
```python
# é€šè¿‡Controllerè°ƒç”¨
quantum_controller = QuantumLabController()
result = quantum_controller.calculate_strength_score(...)
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ImportError: cannot import name 'QuantumLabController'**
   - æ£€æŸ¥`controllers/quantum_lab_controller.py`æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥`__init__.py`æ˜¯å¦æ­£ç¡®å¯¼å‡º

2. **AttributeError: 'QuantumLabController' object has no attribute 'xxx'**
   - æ£€æŸ¥æ–¹æ³•åæ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥Controllerä¸­æ˜¯å¦å®ç°äº†è¯¥æ–¹æ³•

3. **è®¡ç®—ç»“æœä¸æ­£ç¡®**
   - æ£€æŸ¥é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’
   - æ£€æŸ¥MCPä¸Šä¸‹æ–‡æ˜¯å¦æ­£ç¡®æ³¨å…¥
   - æ£€æŸ¥Profileåˆ›å»ºæ˜¯å¦æ­£ç¡®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [V10.0 é‡å­éªŒè¯é¡µé¢æ—ºè¡°åˆ¤å®šåŸºç¡€å‚æ•°è°ƒä¼˜æŒ‡å—](./V10_QUANTUM_LAB_STRENGTH_TUNING_GUIDE.md)
- [V10.0 MCPåè®®æ–‡æ¡£](./V10_MCP_PROTOCOL.md)
- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./ARCHITECTURE.md)
- [MVCæ¶æ„çº¦æŸ](../.cursorrules)

---

## ğŸ“… æ›´æ–°æ—¥å¿—

### 2025-01-17
- âœ… åˆ›å»ºMVCæ¶æ„æ–‡æ¡£
- âœ… å®ŒæˆControllerå±‚å®ç°
- âœ… å®ŒæˆViewå±‚é‡æ„
- âœ… ç§»é™¤è´¢å¯Œ/æƒ…æ„Ÿ/äº‹ä¸šç­‰å®è§‚æŒ‡æ ‡
- âœ… æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

**ç»´æŠ¤è€…**: Bazi Predict Team  
**æœ€åæ›´æ–°**: 2025-01-17

