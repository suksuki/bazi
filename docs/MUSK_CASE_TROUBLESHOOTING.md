# 🔧 Musk案例故障排除指南

## 问题：测试Musk案例时结果不对

### 可能的原因

1. **数据格式不兼容**
   - 旧系统使用 `data/golden_timeline.json`（数组格式）
   - 新MVC系统使用 `data/*_timeline.json`（每个文件一个案例）

2. **案例未导入到新系统**
   - Musk案例可能还在旧格式文件中
   - 新系统无法读取旧格式

3. **大运计算问题**
   - 旧系统可能使用固定大运
   - 新系统需要根据出生日期计算实际大运

4. **验证逻辑变化**
   - 旧验证脚本直接调用引擎
   - 新系统通过Controller验证，可能有逻辑差异

---

## 🔍 诊断步骤

### 步骤1：检查Musk案例是否存在

运行诊断脚本：

```bash
python3 scripts/check_imported_cases.py
```

查看是否包含 `TIMELINE_MUSK_WEALTH` 或 `Elon Musk`。

### 步骤2：导入Musk案例到新系统

运行导入脚本：

```bash
python3 scripts/import_musk_case.py
```

这个脚本会：
- 从旧文件加载Musk案例（如果存在）
- 或使用默认数据创建Musk案例
- 计算实际大运（使用BaziProfile）
- 导入到新MVC系统
- 自动验证结果

---

## ✅ 解决方案

### 方案1：运行导入脚本（推荐）

```bash
python3 scripts/import_musk_case.py
```

**预期输出：**
```
📥 导入Musk案例到MVC系统
📂 从旧文件加载Musk案例...
✅ 找到Musk案例: Elon Musk
✅ BaziProfile创建成功
🔄 转换数据格式...
✅ 格式转换完成
💾 导入到MVC系统...
✅ 成功导入 1/1 个案例
🧪 测试验证...
✅ 验证完成
   命中率: XX.X% (X/4)
   平均误差: XX.X分
```

### 方案2：在UI中验证

1. 启动应用：`streamlit run main.py`
2. 访问"💰 财富验证"页面
3. 选择"Elon Musk"案例
4. 点击"🚀 开始验证"
5. 查看结果和详细分析

---

## 📋 Musk案例数据

**基本信息：**
- ID: `TIMELINE_MUSK_WEALTH`
- 姓名: `Elon Musk`
- 八字: `辛亥 甲午 甲申 甲子`
- 日主: `甲`
- 性别: `男`
- 出生日期: 1971年6月28日 7:30（辰时）

**事件列表：**
1. **1999年** - 第一桶金（Zip2获利）
   - 真实值: 60.0
   - 流年: 己卯
   - 大运: 丁酉

2. **2002年** - eBay收购PayPal
   - 真实值: 80.0
   - 流年: 壬午
   - 大运: 丁酉

3. **2008年** - 破产危机
   - 真实值: -90.0
   - 流年: 戊子
   - 大运: 戊戌

4. **2021年** - 登顶首富
   - 真实值: 100.0
   - 流年: 辛丑
   - 大运: 己亥

---

## 🔍 验证逻辑对比

### 旧验证脚本 (`scripts/verify_wealth_timeline.py`)
- 直接读取 `data/golden_timeline.json`
- 直接调用 `engine.calculate_wealth_index()`
- 使用固定大运（从数据中读取）

### 新MVC系统 (`controllers/wealth_verification_controller.py`)
- 从 `data/*_timeline.json` 加载案例
- 通过Controller调用引擎
- 使用BaziProfile计算实际大运

**关键差异：**
- 新系统会重新计算大运，可能更准确
- 新系统有更详细的错误处理
- 新系统提供更丰富的分析信息

---

## 🐛 常见问题

### 问题1：预测值偏差大

**可能原因：**
- 大运计算不准确
- 引擎参数变化
- 算法版本更新

**解决方法：**
1. 检查大运是否正确
2. 对比新旧系统的引擎配置
3. 查看详细分析信息，找出触发机制

### 问题2：某些年份预测失败

**可能原因：**
- 数据格式问题
- 引擎计算错误
- 大运或流年格式不正确

**解决方法：**
1. 检查错误信息
2. 验证数据格式
3. 查看引擎日志

### 问题3：命中率下降

**可能原因：**
- 算法调优导致参数变化
- 验证标准变化（新系统使用20分误差阈值）

**解决方法：**
1. 对比新旧系统的验证标准
2. 检查算法版本
3. 查看详细分析，找出问题年份

---

## 📊 预期结果

导入和验证后，应该看到：

1. **案例已导入**：在UI中可以看到"Elon Musk"案例
2. **验证结果**：
   - 1999年：预测值应该在40-80之间（真实60）
   - 2002年：预测值应该在60-100之间（真实80）
   - 2008年：预测值应该在-100到-50之间（真实-90）
   - 2021年：预测值应该在80-100之间（真实100）
3. **命中率**：至少2/4（50%）以上
4. **平均误差**：应该在30-50分之间

---

## 🔄 如果结果仍然不对

1. **检查引擎版本**：确认使用的是最新版本的GraphNetworkEngine
2. **检查配置参数**：查看 `config/parameters.json` 是否有变化
3. **对比旧结果**：运行旧的验证脚本 `scripts/verify_wealth_timeline.py` 对比结果
4. **查看详细分析**：在UI中展开每个事件的详细分析，查看触发机制

---

**文档更新时间**: 2024  
**维护者**: Quantum Bazi GEM Team

