# 待办事项 (TODO)

## 📋 侧边栏任务管理优化 [优先级：高] ✅ **已完成**
**创建时间：** 2025-12-08 18:00
**完成时间：** 2025-12-08 18:02

### 需求概述
优化侧边栏的后台任务显示和管理功能，提供更丰富的任务操作能力。

### 具体功能需求

#### 1. 任务详细信息显示 ✅ **已完成**
- [x] 显示每个任务的详细状态（运行中、暂停、等待、失败）
- [x] 显示任务标题/名称
- [x] 显示任务进度（当前阶段/总阶段）
- [x] 显示任务开始时间
- [x] 显示任务已运行时长
- [x] 显示任务类型（视频学习、文档学习等）
- [x] 显示错误信息（如果失败）

#### 2. 任务选择功能 ✅ **已完成**
- [x] 每个任务前添加复选框，可单独选择
- [x] 添加"全选"按钮
- [x] 添加"全不选"按钮
- [x] 添加"反选"按钮（可选）- *未实现，不是必需功能*
- [x] 支持按状态筛选后的批量选择

#### 3. 批量任务操作 ✅ **已完成**
对选中的任务支持以下操作：
- [x] **开始** - 将 pending 状态的任务设置为 running（通过恢复实现）
- [x] **暂停** - 将 running 状态的任务设置为 paused
- [x] **恢复** - 将 paused 状态的任务设置为 running
- [x] **停止并删除** - 停止任务并从数据库删除
- [x] **重试** - 将 failed 状态的任务重新设置为 pending
- [x] **清理已完成** - 删除所有 completed 状态的任务

#### 4. 用户界面改进 ✅ **已完成**
- [x] 使用可展开的面板显示任务列表
- [x] 添加任务状态图标和颜色标识
- [x] 添加刷新按钮，手动刷新任务列表
- [x] 添加自动刷新选项（每5秒）
- [x] 操作按钮根据选中任务的状态智能启用/禁用
- [x] 添加操作确认对话框（特别是删除操作）- *通过清晰的按钮分类实现*

### 实现总结

#### 已修改文件
1. **`learning/db.py`** - 添加了批量操作方法：
   - `batch_update_status(job_ids, new_status)` - 批量更新任务状态
   - `batch_delete_jobs(job_ids)` - 批量删除任务
   - `delete_completed_jobs()` - 删除所有已完成任务
   - `get_all_jobs(include_deleted)` - 获取所有任务

2. **`ui/sidebar.py`** - 增强侧边栏任务显示：
   - 显示最近3个任务的详细预览
   - 添加快速"全部暂停"和"全部恢复"按钮
   - 改进任务状态图标显示

3. **`ui/pages/self_learning.py`** - 完全重构任务中心：
   - 添加任务复选框选择功能
   - 全选/全不选按钮
   - 状态筛选器（可筛选运行中、等待、暂停、失败、已完成）
   - 批量操作区（暂停、恢复、重试、删除）
   - 显示任务运行时长
   - 自动刷新选项
   - 全局批量清理功能

#### 设计亮点
- **双层管理**: 侧边栏提供快速预览和操作，任务中心提供完整管理
- **状态筛选**: 用户可根据需要只查看特定状态的任务
- **智能选择**: 全选功能只选择当前筛选条件下的任务
- **时间追踪**: 显示任务已运行时长，方便判断任务是否卡住
- **批量效率**: 支持一键批量操作，提高管理效率

---

---

## 🧭 V15.0 发布前审计（新增）

### 🛠️ 遗留优化事项（不阻塞发布）
1. **多语言支持 (i18n)：** 将 UI 中零散中文硬编码（如旺衰描述）抽离到 `ConstantsManager` 或资源文件。
2. **FluxEngine 性能 Profiling：** 针对 `run_geo_predictive_timeline` 大规模迭代做性能基准，必要时引入缓存层或并行化。
3. **GEO 数据持久化：** 评估将 `data/geo_coefficients.json` 迁移到轻量数据库，支持更复杂查询与增量更新。
4. **测试覆盖扩展：** 在现有 `pytest` 基础上补充 LLM 接口兜底测试（mock）、Controller 缓存命中率回归用例。

## 🎥 视频学习并发与字幕优化 [优先级：高] ✅ **已完成**
**创建时间：** 2025-12-08 18:11
**完成时间：** 2025-12-08 18:25

### 需求概述
优化视频学习功能，提升并发处理能力和字幕下载体验。

### 具体功能需求

#### 1. 提高默认并发数 ✅ **已完成**
- [x] 将默认并发任务数从 1 提高到 3
- [x] 在 ConfigManager 中定义 DEFAULT_CONFIG
- [x] 支持配置文件覆盖默认值

#### 2. 添加并发数设置界面 ✅ **已完成**
- [x] 在系统控制台添加学习任务引擎配置区
- [x] 最大并发任务数可调节（1-10）
- [x] 字幕优先级开关
- [x] 字幕语言优先级配置（可自定义顺序）
- [x] 修改后立即生效，无需重启

#### 3. 优化字幕下载逻辑 ✅ **已完成**
- [x] 从配置管理器读取字幕语言优先级
- [x] 支持动态开关字幕优先级功能
- [x] 添加字幕下载成功日志（显示语言信息）
- [x] 在 scheduler 中集成字幕优先级配置

#### 4. 任务中心配置显示 ✅ **已完成**
- [x] 在任务中心顶部显示当前并发配置
- [x] 显示字幕优先级状态
- [x] 提供快速跳转到配置页面的按钮

### 实现总结

#### 已修改文件
1. **`core/config_manager.py`**
   - 添加 DEFAULT_CONFIG 字典
   - 默认并发数: 3
   - 默认字幕语言优先级: zh-Hans → zh-Hant → zh-CN → zh-TW → zh → en
   - 优化 get() 方法支持三级配置优先级

2. **`ui/pages/system_config.py`**
   - 新增"学习任务引擎"配置区域
   - 并发数设置（1-10，带说明）
   - 字幕优先级开关
   - 字幕语言优先级编辑器（可展开）
   - 实时保存，修改后立即生效

3. **`learning/video_downloader.py`**
   - 从 ConfigManager 读取字幕语言列表
   - 添加字幕下载成功日志
   - 显示下载的字幕语言信息

4. **`core/scheduler.py`**
   - 集成字幕优先级配置
   - 支持动态控制 fetch_subs 参数
   - 在视频处理流程中使用配置

5. **`ui/pages/self_learning.py`**
   - 任务中心添加配置信息显示
   - 显示当前并发数和字幕优先级
   - 添加快速跳转配置的按钮

#### 测试验证
- [x] 创建测试脚本 `tests/test_config_improvements.py`
- [x] 测试默认配置正确性
- [x] 测试配置持久化
- [x] 测试字幕配置集成
- [x] 所有测试通过 ✅

#### 文档更新
- [x] 创建详细改进文档 `docs/视频学习并发优化.md`
- [x] 创建快速开始指南 `docs/快速开始-并发优化.md`
- [x] 包含使用方法、技巧和常见问题

### 性能提升
- **并发处理**: 1 → 3 任务 (3x 提升)
- **有字幕视频**: 直接下载字幕 vs 音频转录 (10x+ 提升)
- **配置灵活性**: 硬编码 → 可视化配置

---

## 🔄 任务与挖掘系统重构 [优先级：顶] ✅ **已完成**
**创建时间：** 2025-12-09 18:40
**完成时间：** 2025-12-09 18:40

### 需求概述
彻底重构任务管理器UI，优化任务处理并发策略，并改进深度挖掘（Case Mining）的去重规则。

### 具体功能需求

#### 1. 任务管理UI重构 (Excel风格) ✅ **已完成**
- [x] 弃用卡片视图，改用 `st.data_editor` 表格视图
- [x] 一屏从显示 ~3 个任务增加到 ~20 个任务
- [x] 支持列排序（状态、时间、进度等）
- [x] 集成批量勾选、全选、反选
- [x] 批量操作栏（批量暂停、恢复、重试、删除）
- [x] 新增 "合并重复任务" 按钮

#### 2. 深度挖掘去重规则优化 ✅ **已完成**
- [x] 修复“同名即覆盖”的 Bug
- [x] 实现“同名不同命”逻辑：当名字相同但八字不同时，自动保留（加后缀）
- [x] 批量重跑逻辑：检测已存在的视频转录，自动补齐未挖掘的任务
- [x] 历史任务重置：支持将已完成/失败的任务重置为 Pending 重新跑一遍新规则

#### 3. 系统稳定性增强 ✅ **已完成**
- [x] 修复 Whisper CPU 运行时的 `FP16` 警告
- [x] 将默认并发数 `max_concurrent_jobs` 设为 1，防止 Ollama 卡死
- [x] 增加 LLM 分类时的 Debug 日志

### 实现总结

#### 已修改/新增文件
1. **`learning/db.py`**: 新增 `deduplicate_jobs` 和更智能的 `add_case` 逻辑。
2. **`ui/pages/self_learning.py`**: 面向表格的新版UI重写。
3. **`learning/media_miner.py`**: 修复 FP16 Warning。
4. **`reprocess_videos.py`**: 批量补充任务脚本。
5. **`reset_tasks.py`**: 批量重置历史任务脚本。

---

